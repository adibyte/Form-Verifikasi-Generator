<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FORM VERDIK GENERATOR | Kemensos RI</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #10b981;
            --bg-body: #f1f5f9;
            --text-dark: #1e293b;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; color: var(--text-dark); 
            background-color: var(--bg-body); 
        }

        /* --- UI DASHBOARD (RATA KIRI) --- */
        .no-print { 
            background: #ffffff; padding: 40px; border-radius: 0 0 25px 25px; 
            margin: 0 auto 30px auto; max-width: 1100px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: left; /* Rata Kiri */
        }

        h1.main-title { color: var(--primary-color); margin: 0 0 10px 0; font-size: 26px; font-weight: 700; }
        .guide-text { color: #64748b; font-size: 14px; margin-bottom: 30px; }

        .card-input {
            background: #f8fafc; border: 1px solid #e2e8f0;
            padding: 25px; border-radius: 15px; margin-bottom: 25px;
        }

        .label-input { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #475569; }

        .input-group { 
            display: flex; 
            justify-content: flex-start; /* Rata Kiri */
            gap: 15px; 
            flex-wrap: wrap; 
        }

        .input-field {
            flex: 1; min-width: 250px;
        }

        .input-group input { 
            width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 8px; 
            font-size: 14px; outline: none; box-sizing: border-box;
        }
        .input-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        #dropZone { 
            border: 2px dashed #3498db; background: #f0f9ff; padding: 40px; border-radius: 15px; 
            cursor: pointer; color: #3b82f6; text-align: left; transition: 0.3s;
            display: flex; align-items: center; gap: 20px;
        }
        #dropZone:hover { background: #e0f2fe; border-color: #2563eb; }
        #dropZone .icon { font-size: 40px; }

        .action-area { 
            margin-top: 40px; border-top: 1px solid #e2e8f0; padding-top: 30px;
            display: flex; gap: 15px;
        }

        .btn { padding: 14px 28px; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; font-size: 15px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-generate { background: var(--primary-color); color: white; }
        .btn-save { background: var(--secondary-color); color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* --- PRINT LAYOUT --- */
        .page-container { 
            width: 28.7cm; margin: 20px auto; padding: 0; background: white;
            box-sizing: border-box; page-break-after: always; color: black;
        }
        .kop-surat { display: flex; align-items: center; border-bottom: 2.5px solid #000; padding-bottom: 8px; margin-bottom: 10px; }
        .logo-box { width: 60px; }
        .logo-box img { width: 100%; }
        .header-text { text-align: center; flex-grow: 1; }
        .header-text h2 { margin: 0; font-size: 14px; text-transform: uppercase; }
        .header-text .school-name { margin: 3px 0; font-size: 18px; font-weight: 800; text-transform: uppercase; }
        
        table { width: 100%; border-collapse: collapse; border: 1.5px solid black; }
        th, td { border: 1px solid black; padding: 4px 6px; font-size: 9px; color: black; }
        th { background-color: #f1f5f9 !important; -webkit-print-color-adjust: exact; }

        .signature-wrapper { margin-top: 20px; }
        .footer-container { display: flex; justify-content: space-between; }
        .signature-box { width: 300px; text-align: center; font-size: 11px; }
        .space { height: 50px; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            @page { size: A4 landscape; margin: 0.5cm; }
            .page-container { width: 100%; box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <h1 class="main-title">FORM VERDIK GENERATOR</h1>
    <p class="guide-text">Input data pendamping dan unggah file CSV hasil download Verifikasi Pendidikan.</p>

    <div class="card-input">
        <div class="input-group">
            <div class="input-field">
                <label class="label-input">üìç Wilayah Tugas (Kab/Kota)</label>
                <input type="text" id="kabupatenInput" placeholder="Contoh: Kabupaten Aceh Utara" />
            </div>
            <div class="input-field">
                <label class="label-input">‚úçÔ∏è Nama Pendamping</label>
                <input type="text" id="namaPendampingInput" placeholder="Nama Lengkap & Gelar" />
            </div>
            <div class="input-field">
                <label class="label-input">üÜî NIP / Kode Pendamping</label>
                <input type="text" id="nipPendampingInput" placeholder="NIP atau NIK" />
            </div>
        </div>
    </div>

    <div id="dropZone">
        <div class="icon">üìÇ</div>
        <div>
            <p id="dropText" style="margin:0; font-weight:700;">Tarik & Lepaskan File CSV di sini</p>
            <p style="margin:5px 0 0 0; font-size:13px; color:#64748b;">Atau klik untuk memilih file dari komputer (Bisa banyak file sekaligus)</p>
        </div>
        <input type="file" id="csvFiles" accept=".csv" multiple style="display: none;" />
    </div>
    <div id="fileStatus" style="margin-top:10px; font-size:14px; color:#059669; font-weight:bold;"></div>

    <div class="action-area">
        <button onclick="processMassiveCSVs()" class="btn btn-generate">‚öôÔ∏è GENERATE SEKARANG</button>
        <button onclick="saveAndReport()" class="btn btn-save">üíæ CETAK & KIRIM LAPORAN</button>
    </div>
</div>

<div id="outputArea"></div>

<script>
    let selectedFiles = [];
    const scriptURL = 'TEMPEL_URL_GOOGLE_APPS_SCRIPT_ANDA'; // Masukkan URL Web App Script Anda di sini

    const fileInput = document.getElementById('csvFiles');
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#2563eb'; });
    dropZone.addEventListener('dragleave', () => { dropZone.style.borderColor = '#3498db'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
        selectedFiles = Array.from(files);
        document.getElementById('fileStatus').innerText = `‚úÖ ${selectedFiles.length} File CSV terpilih`;
    }

    async function processMassiveCSVs() {
        const outputArea = document.getElementById('outputArea');
        const kab = document.getElementById('kabupatenInput').value || "....................";
        const namaP = document.getElementById('namaPendampingInput').value || "....................";
        const nipP = document.getElementById('nipPendampingInput').value || "....................";

        if (selectedFiles.length === 0) return alert("Silakan pilih file CSV terlebih dahulu!");

        outputArea.innerHTML = '<p class="no-print" style="padding:20px;">Sedang memproses...</p>';
        let finalHtml = '';

        for (let file of selectedFiles) {
            const data = await readFileData(file);
            finalHtml += generateSchoolPage(data, namaP, nipP, kab);
        }
        outputArea.innerHTML = finalHtml;
    }

    function readFileData(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split(/\r?\n/);
                let info = { nama: "NAMA SEKOLAH", npsn: "-" };
                let students = [];
                
                lines.forEach(line => {
                    let cols = line.split(';');
                    let s = line.toUpperCase();
                    if (s.includes("NPSN")) info.npsn = cols[1]?.replace(/[^0-9]/g, '');
                    if (s.includes("NAMA SEKOLAH")) info.nama = cols[1]?.replace(/[:"']/g, '').trim();
                    
                    if (cols.length > 5 && !isNaN(parseInt(cols[0]))) {
                        students.push({
                            pengurus: cols[2]?.trim(),
                            siswa: cols[5]?.trim(),
                            nik: cols[3]?.trim(),
                            nisn: cols[4]?.trim(),
                            tingkat: cols[7]?.trim(),
                            pendamping: cols[cols.length-1]?.trim()
                        });
                    }
                });
                resolve({ info, students });
            };
            reader.readAsText(file, 'ISO-8859-1');
        });
    }

    function generateSchoolPage(data, namaP, nipP, kab) {
        let rows = data.students.map((s, i) => `
            <tr>
                <td align="center">${i + 1}</td>
                <td>${s.pengurus}</td>
                <td>${s.siswa}</td>
                <td align="center">${s.nik}</td>
                <td align="center">${s.nisn}</td>
                <td align="center">${s.tingkat}</td>
                <td></td><td></td><td></td><td></td>
                <td></td>
                <td style="font-size:8px">${s.pendamping}</td>
            </tr>`).join('');

        return `
        <div class="page-container">
            <div class="kop-surat">
                <div class="logo-box"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Lambang_Kementerian_Sosial.png"></div>
                <div class="header-text">
                    <h2>Form Verifikasi Komitmen Pendidikan</h2>
                    <p class="school-name">${data.info.nama}</p>
                    <p style="font-size:11px;">NPSN: ${data.info.npsn} | Periode: TA 2025/2026</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">NO</th><th rowspan="2">PENGURUS</th><th rowspan="2">NAMA SISWA</th>
                        <th rowspan="2">NIK</th><th rowspan="2">NISN</th><th rowspan="2">TKT</th>
                        <th colspan="4">KEHADIRAN</th><th rowspan="2">KET</th><th rowspan="2">PENDAMPING</th>
                    </tr>
                    <tr><th>A</th><th>I</th><th>S</th><th>%</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            <div class="footer-container signature-wrapper">
                <div class="signature-box">
                    <p>Mengetahui,</p>
                    <p>Pendamping PKH</p>
                    <div class="space"></div>
                    <p><strong>${namaP.toUpperCase()}</strong></p>
                    <p>NIP. ${nipP}</p>
                </div>
                <div class="signature-box">
                    <p>${kab}, ${new Date().toLocaleDateString('id-ID')}</p>
                    <p>Kepala Sekolah</p>
                    <div class="space"></div>
                    <p><strong>__________________________</strong></p>
                    <p>NIP. ___________________</p>
                </div>
            </div>
        </div>`;
    }

    function saveAndReport() {
        // 1. Kirim Data ke Google Sheets (Log Laporan)
        const namaP = document.getElementById('namaPendampingInput').value;
        const kab = document.getElementById('kabupatenInput').value;
        
        if(namaP && scriptURL !== 'TEMPEL_URL_GOOGLE_APPS_SCRIPT_ANDA') {
            fetch(scriptURL, {
                method: 'POST',
                body: JSON.stringify({
                    nama: namaP,
                    nip: document.getElementById('nipPendampingInput').value,
                    kegiatan: "Generate Form Verdik " + selectedFiles.length + " Sekolah di " + kab
                })
            });
        }

        // 2. Buka dialog Cetak
        window.print();
    }
</script>
</body>
</html>
